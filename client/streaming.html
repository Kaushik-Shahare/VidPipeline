<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Watch â€¢ VidPipeline</title>
    <style>
      :root {
        --bg: #0f0f0f;
        --panel: #181818;
        --text: #e6e6e6;
        --muted: #aaaaaa;
        --border: #2a2a2a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
      }
      .logo-badge {
        width: 24px;
        height: 24px;
        background: #ff3d00;
        border-radius: 6px;
      }
      .watch {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 18px;
        padding: 16px;
      }
      .player {
        background: #000;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }
      .quality-box {
        margin-top: 10px;
        padding: 10px;
        display: inline-block;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
      }
      select {
        background: #111;
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 6px;
        color: var(--text);
      }
      .title {
        font-weight: 700;
        font-size: 18px;
        margin: 12px 0 4px 0;
      }
      .meta {
        color: var(--muted);
        font-size: 12px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }
      .stack {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      video {
        width: 100%;
        height: auto;
        display: block;
      }
      .upnext-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        text-decoration: none;
        color: var(--text);
      }
      .upnext-item img {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid var(--border);
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  </head>
  <body>
    <header class="header">
      <span class="logo-badge"></span>
      <span>VidPipeline</span>
    </header>

    <main class="watch">
      <section>
        <div id="player" class="player">
          <video id="videoEl" controls playsinline></video>
        </div>

        <!-- Always-visible Quality Selector -->
        <div class="quality-box">
          <label
            style="font-size: 12px; color: var(--muted); margin-right: 6px"
          >
            Quality:
          </label>
          <select id="qualitySelect">
            <option value="-1">Auto</option>
          </select>
        </div>

        <div id="videoTitle" class="title"></div>
        <div id="videoMeta" class="meta"></div>
      </section>

      <aside class="panel">
        <div style="font-weight: 700; margin-bottom: 8px">Up Next</div>
        <div id="upnext" class="stack"></div>
      </aside>
    </main>

    <script>
      const BACKEND_URL = "http://localhost:8000";
      const qualitySelect = document.getElementById("qualitySelect");

      let hlsInstance = null;

      function isAbsoluteUrl(u) {
        return typeof u === "string" && /^(https?:)?\/\//i.test(u);
      }
      function resolveUrl(u) {
        return isAbsoluteUrl(u) ? u : `${BACKEND_URL}${u}`;
      }
      function hasSasQuery(u) {
        return /[?&]sig=/i.test(u);
      }
      function normalizeToken(token) {
        return token ? token.replace(/^\?/, "") : "";
      }
      function appendSas(url, token) {
        if (!token || hasSasQuery(url) || !isAbsoluteUrl(url)) return url;
        return url + (url.includes("?") ? "&" : "?") + token;
      }

      async function fetchVideos() {
        const resp = await fetch(`${BACKEND_URL}/videos`);
        return await resp.json();
      }

      const urlParams = new URLSearchParams(window.location.search);
      const vhash = urlParams.get("v");

      const videoEl = document.getElementById("videoEl");
      const titleEl = document.getElementById("videoTitle");
      const metaEl = document.getElementById("videoMeta");
      const upnextEl = document.getElementById("upnext");

      function pickVideo(videos) {
        if (!vhash) return videos[0];
        return videos.find((v) => v.video_hash === vhash) || videos[0];
      }

      function renderUpNext(videos, current) {
        upnextEl.innerHTML = "";
        videos
          .filter((v) => v.video_hash !== current.video_hash)
          .slice(0, 6)
          .forEach((v) => {
            const a = document.createElement("a");
            a.href = `./streaming.html?v=${encodeURIComponent(v.video_hash)}`;
            a.className = "upnext-item";

            const img = document.createElement("img");
            img.src = v.thumbnail_url
              ? resolveUrl(v.thumbnail_url)
              : "https://via.placeholder.com/80x45?text=No+Thumbnail";

            const span = document.createElement("span");
            span.textContent = v.title || "Untitled";

            a.appendChild(img);
            a.appendChild(span);
            upnextEl.appendChild(a);
          });
      }

      function setupHlsQuality(hls) {
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          qualitySelect.innerHTML = `<option value="-1">Auto</option>`;

          hls.levels.forEach((lvl, index) => {
            const opt = document.createElement("option");
            opt.value = index;
            opt.textContent = `${lvl.height}p`;
            qualitySelect.appendChild(opt);
          });

          qualitySelect.onchange = () => {
            const level = parseInt(qualitySelect.value);
            hls.currentLevel = level;
          };
        });
      }

      function playVideo(video) {
        titleEl.textContent = video.title || "Untitled";
        metaEl.textContent = video.status;

        const token = normalizeToken(video.azure_sas_token);

        if (hlsInstance) {
          hlsInstance.destroy();
          hlsInstance = null;
        }

        if (video.hls_url) {
          const src = appendSas(resolveUrl(video.hls_url), token);

          if (Hls.isSupported()) {
            hlsInstance = new Hls();
            hlsInstance.loadSource(src);
            hlsInstance.attachMedia(videoEl);
            setupHlsQuality(hlsInstance);
          } else {
            videoEl.src = src;
          }
        }
      }

      (async () => {
        const videos = await fetchVideos();
        if (!videos.length) {
          titleEl.textContent = "No videos yet";
          return;
        }

        const current = pickVideo(videos);
        renderUpNext(videos, current);
        playVideo(current);
      })();
    </script>
  </body>
</html>
