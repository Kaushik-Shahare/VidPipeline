<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Watch â€¢ VidPipeline</title>
    <style>
      :root {
        --bg: #0f0f0f;
        --panel: #181818;
        --text: #e6e6e6;
        --muted: #aaaaaa;
        --border: #2a2a2a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
      }
      .logo-badge {
        width: 24px;
        height: 24px;
        background: #ff3d00;
        border-radius: 6px;
        display: inline-block;
      }
      .watch {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 18px;
        padding: 16px;
      }
      .player {
        background: #000;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }
      .title {
        font-weight: 700;
        font-size: 18px;
        margin: 10px 0;
      }
      .meta {
        color: var(--muted);
        font-size: 12px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }
      .stack {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      video {
        width: 100%;
        height: auto;
        display: block;
      }
      .pill {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        font-size: 12px;
      }
      .upnext-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        text-decoration: none;
        color: var(--text);
      }
      .upnext-item img {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid var(--border);
      }
      .upnext-item span {
        font-size: 14px;
        flex: 1;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  </head>
  <body>
    <header class="header">
      <span class="logo-badge"></span>
      <span>VidPipeline</span>
    </header>
    <main class="watch">
      <section>
        <div id="player" class="player">
          <video id="videoEl" controls playsinline></video>
        </div>
        <div id="videoTitle" class="title"></div>
        <div id="videoMeta" class="meta"></div>
        <div class="stack" style="margin-top: 12px">
          <span class="pill">HLS</span>
          <span class="pill">DASH</span>
        </div>
      </section>
      <aside class="panel">
        <div style="font-weight: 700; margin-bottom: 8px">Up Next</div>
        <div id="upnext" class="stack"></div>
      </aside>
    </main>
    <script>
      const BACKEND_URL = "http://localhost:8000";

      function isAbsoluteUrl(u) {
        return typeof u === "string" && /^(https?:)?\/\//i.test(u);
      }

      function resolveUrl(u) {
        if (!u) return null;
        return isAbsoluteUrl(u) ? u : `${BACKEND_URL}${u}`;
      }

      function hasSasQuery(u) {
        return typeof u === "string" && /[?&]sig=/i.test(u);
      }

      function normalizeToken(token) {
        if (!token) return "";
        return token.startsWith("?") ? token.slice(1) : token;
      }

      function appendSas(url, token) {
        if (!token || !url || hasSasQuery(url) || !isAbsoluteUrl(url)) return url;
        const separator = url.includes("?") ? "&" : "?";
        return `${url}${separator}${token}`;
      }

      function createHlsLoader(token, originHint) {
        if (!token) return Hls.DefaultConfig.loader;
        const baseLoader = Hls.DefaultConfig.loader;

        return class TokenLoader extends baseLoader {
          constructor(config) {
            super(config);
          }

          load(context, config, callbacks) {
            if (context && typeof context.url === "string") {
              const shouldAppend =
                (!originHint || context.url.startsWith(originHint)) &&
                !hasSasQuery(context.url) &&
                isAbsoluteUrl(context.url);
              if (shouldAppend) {
                context.url = appendSas(context.url, token);
              }
            }
            super.load(context, config, callbacks);
          }
        };
      }
      const urlParams = new URLSearchParams(window.location.search);
      const vhash = urlParams.get("v");

      const videoEl = document.getElementById("videoEl");
      const titleEl = document.getElementById("videoTitle");
      const metaEl = document.getElementById("videoMeta");
      const upnextEl = document.getElementById("upnext");

      async function fetchVideos() {
        const resp = await fetch(`${BACKEND_URL}/videos`);
        return await resp.json();
      }

      function pickVideo(videos) {
        if (!vhash) return videos[0];
        return videos.find((x) => x.video_hash === vhash) || videos[0];
      }

      function renderUpNext(videos, current) {
        upnextEl.innerHTML = "";
        videos
          .filter((v) => v.video_hash !== current.video_hash)
          .slice(0, 6)
          .forEach((v) => {
            const a = document.createElement("a");
            a.href = `./streaming.html?v=${encodeURIComponent(v.video_hash)}`;
            a.className = "upnext-item";

            const img = document.createElement("img");
            img.src = v.thumbnail_url
              ? resolveUrl(v.thumbnail_url)
              : "https://via.placeholder.com/80x45?text=No+Thumbnail";

            const span = document.createElement("span");
            span.textContent = v.title || "Untitled";

            a.appendChild(img);
            a.appendChild(span);
            upnextEl.appendChild(a);
          });
      }

      function playVideo(video) {
        titleEl.textContent = video.title || "Untitled";
        metaEl.textContent = video.status;
        const sasToken = normalizeToken(video.azure_sas_token);
        if (video.hls_url) {
          const hlsSrc = resolveUrl(video.hls_url);
          if (Hls.isSupported()) {
            let originHint = null;
            try {
              originHint = hlsSrc ? new URL(hlsSrc).origin : null;
            } catch (_) {
              originHint = null;
            }

            const hlsConfig = {};
            if (sasToken) {
              hlsConfig.loader = createHlsLoader(sasToken, originHint);
            }
            const hls = new Hls(hlsConfig);
            hls.loadSource(appendSas(hlsSrc, sasToken));
            hls.attachMedia(videoEl);
          } else if (videoEl.canPlayType("application/vnd.apple.mpegurl")) {
            videoEl.src = appendSas(hlsSrc, sasToken);
          }
        } else if (video.dash_url) {
          const dashSrc = resolveUrl(video.dash_url);
          const player = dashjs.MediaPlayer().create();
          if (sasToken) {
            player.extend(
              "RequestModifier",
              function () {
                return {
                  modifyRequestHeader: (xhr) => xhr,
                  modifyRequestURL: (url) => appendSas(url, sasToken),
                };
              },
              true
            );
          }
          player.initialize(videoEl, appendSas(dashSrc, sasToken), true);
        }
      }

      (async () => {
        const videos = await fetchVideos();
        if (!videos.length) {
          titleEl.textContent = "No videos yet";
          return;
        }
        const current = pickVideo(videos);
        renderUpNext(videos, current);
        playVideo(current);
      })();
    </script>
  </body>
</html>
