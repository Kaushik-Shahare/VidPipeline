<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Video Chunk Upload</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #progress {
        margin-top: 10px;
      }
      #result {
        margin-top: 20px;
      }
      progress {
        width: 100%;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <h2>Video Upload Demo</h2>
    <input type="file" id="videoFile" />
    <button onclick="uploadVideo()">Upload Video</button>

    <div id="progress">
      <progress id="progressBar" value="0" max="100"></progress>
      <span id="progressText"></span>
    </div>
    <div id="result"></div>

    <script>
      // Change this to your backend URL
      const BACKEND_URL = "http://localhost:8000";

      async function uploadVideo() {
        const fileInput = document.getElementById("videoFile");
        const file = fileInput.files[0];
        if (!file) return alert("Select a file first");

        const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB per chunk
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        const videoTitle = file.name;

        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        const resultDiv = document.getElementById("result");

        // 1. Initialize video upload
        const initResp = await fetch(`${BACKEND_URL}/videos/init`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: videoTitle,
            total_chunks: totalChunks,
          }),
        });
        const initData = await initResp.json();
        const videoHash = initData.video_hash;

        console.log("Video initialized:", initData);

        // 2. Upload chunks sequentially
        for (let i = 0; i < totalChunks; i++) {
          const start = i * CHUNK_SIZE;
          const end = Math.min(file.size, start + CHUNK_SIZE);
          const chunk = file.slice(start, end);

          const formData = new FormData();
          formData.append("chunk_data", chunk);

          try {
            await fetch(
              `${BACKEND_URL}/videos/upload_chunk/${videoHash}/${i}`,
              {
                method: "POST",
                body: formData,
              },
            );
          } catch (err) {
            alert(`Failed to upload chunk ${i}: ${err}`);
            return;
          }

          const percent = Math.round(((i + 1) / totalChunks) * 100);
          progressBar.value = percent;
          progressText.innerText = ` Uploaded chunk ${i + 1}/${totalChunks} (${percent}%)`;
        }

        // 3. Finalize upload
        try {
          const finalizeResp = await fetch(
            `${BACKEND_URL}/videos/finalize/${videoHash}`,
            { method: "POST" },
          );
          const finalizeData = await finalizeResp.json();
          console.log("Upload finalized:", finalizeData);

          resultDiv.innerHTML = `
          <strong>Video processed:</strong>
          <a href="${BACKEND_URL}/${finalizeData.video_url}" target="_blank">Watch Video</a>
        `;
          progressText.innerText = "Upload completed!";
          progressBar.value = 100;
        } catch (err) {
          alert("Failed to finalize video upload: " + err);
        }
      }
    </script>
  </body>
</html>
